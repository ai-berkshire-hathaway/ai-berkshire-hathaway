name: Deploy Frontend to IPFS

on:
  push:
    branches: [ main ]
    paths: [ 'frontend/**' ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Install dependencies
      working-directory: ./frontend
      run: pnpm install
      
    - name: Build project
      working-directory: ./frontend
      run: pnpm build
      
    - name: Deploy to IPFS (Pinata)
      working-directory: ./frontend
      env:
        PINATA_JWT: ${{ secrets.PINATA_JWT }}
      run: |
        # Install Pinata CLI
        npm install -g @pinata/cli
        
        # Upload to IPFS
        IPFS_HASH=$(pinata upload dist --name "ai-berkshire-dca-dashboard-$(date +%Y%m%d-%H%M%S)")
        
        echo "ðŸŽ‰ Deployed to IPFS!"
        echo "IPFS Hash: $IPFS_HASH"
        echo "Gateway URL: https://gateway.pinata.cloud/ipfs/$IPFS_HASH"
        
        # Save hash for ENS update
        echo "IPFS_HASH=$IPFS_HASH" >> $GITHUB_ENV
        
    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š DCA Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- **Contract**: \`0x7D0a62Ef1C43F28b70576390B0334c75D2CBE6D6\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Network**: Base Mainnet" >> $GITHUB_STEP_SUMMARY
        echo "- **IPFS Hash**: \`$IPFS_HASH\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Access Links" >> $GITHUB_STEP_SUMMARY
        echo "- [IPFS Gateway](https://gateway.pinata.cloud/ipfs/$IPFS_HASH)" >> $GITHUB_STEP_SUMMARY
        echo "- [Cloudflare IPFS](https://cloudflare-ipfs.com/ipfs/$IPFS_HASH)" >> $GITHUB_STEP_SUMMARY
        echo "- [Contract on BaseScan](https://basescan.org/address/0x7D0a62Ef1C43F28b70576390B0334c75D2CBE6D6)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ENS Setup" >> $GITHUB_STEP_SUMMARY
        echo "To update your ENS domain:" >> $GITHUB_STEP_SUMMARY
        echo "1. Visit [ENS Manager](https://app.ens.domains/)" >> $GITHUB_STEP_SUMMARY
        echo "2. Select your domain" >> $GITHUB_STEP_SUMMARY
        echo "3. Set Content Hash to: \`ipfs://$IPFS_HASH\`" >> $GITHUB_STEP_SUMMARY
